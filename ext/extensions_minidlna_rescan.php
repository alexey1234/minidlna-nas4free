<?php/*	extensions_minidlna.php*/require("auth.inc");require("guiconfig.inc");require("services.inc");require("ext/minidlna/function.php");$pgtitle = array(gettext("Minidlna"),gettext("Rescan"));// rescan manuallyif (isset ($_GET['act']) && ($_GET['act'] == 'rescan')) {			$file = $config['minidlna']['homefolder']."minidlna.log";$handle=fopen($file, "a+");	fwrite ($handle, "[".date("Y/m/d H:i:s")."] root.nas4free:000: Minidlna begin rescan database". "\n");	$cmd = $config['minidlna']['homefolder']."bin/minidlna_rescan.sh";		mwexec ($cmd);$retval1[] = "minidlna now scan media folders. Plese wait";header("Location: extensions_minidlna_rescan.php");		    }    // Schedule rescan./* Global arrays. */$a_months = explode(" ",gettext("January February March April May June July August September October November December"));$a_weekdays = explode(" ",gettext("Sunday Monday Tuesday Wednesday Thursday Friday Saturday"));$pconfig['rescan'] = $config['minidlna']['rescan'] ;$a_cronjob = &$config['cron']['job'];if (FALSE !== ($cnid = array_search_ex("minidlna", $a_cronjob, "desc"))) {	$pconfig['enable'] = isset($a_cronjob[$cnid]['enable']);	$pconfig['uuid'] = $a_cronjob[$cnid]['uuid'];	$uuid = $a_cronjob[$cnid]['uuid'];	$pconfig['desc'] = $a_cronjob[$cnid]['desc'];	$pconfig['minute'] = $a_cronjob[$cnid]['minute'];	$pconfig['hour'] = $a_cronjob[$cnid]['hour'];	$pconfig['day'] = $a_cronjob[$cnid]['day'];	$pconfig['month'] = $a_cronjob[$cnid]['month'];	$pconfig['weekday'] = $a_cronjob[$cnid]['weekday'];	$pconfig['all_mins'] = $a_cronjob[$cnid]['all_mins'];	$pconfig['all_hours'] = $a_cronjob[$cnid]['all_hours'];	$pconfig['all_days'] = $a_cronjob[$cnid]['all_days'];	$pconfig['all_months'] = $a_cronjob[$cnid]['all_months'];	$pconfig['all_weekdays'] = $a_cronjob[$cnid]['all_weekdays'];	$pconfig['who'] = $a_cronjob[$cnid]['who'];	$pconfig['command'] = $a_cronjob[$cnid]['command'];} else {	$pconfig['enable'] = true;	$pconfig['uuid'] = uuid();	$pconfig['desc'] = "";	$pconfig['all_mins'] = 1;	$pconfig['all_hours'] = 1;	$pconfig['all_days'] = 1;	$pconfig['all_months'] = 1;	$pconfig['all_weekdays'] = 1;	$pconfig['who'] = "root";	$pconfig['command'] = $config['minidlna']['homefolder']."bin/minidlna_rescan.sh";}if (isset($_POST['Submit']) && ($_POST['Submit'] === "Save")) { 	if (isset($_POST['uuid'])) $uuid = $_POST['uuid'];	unset($input_errors);			do_input_validate_synctime($_POST, $input_errors);		if (empty($input_errors)) {		$pconfig = $_POST;		$cronjob = array();		$cronjob['enable'] = true;		$cronjob['uuid'] = $_POST['uuid'];		$cronjob['desc'] = 'minidlna';		$cronjob['minute'] = !empty($_POST['minute']) ? $_POST['minute'] : null;		$cronjob['hour'] = !empty($_POST['hour']) ? $_POST['hour'] : null;		$cronjob['day'] = !empty($_POST['day']) ? $_POST['day'] : null;		$cronjob['month'] = !empty($_POST['month']) ? $_POST['month'] : null;		$cronjob['weekday'] = !empty($_POST['weekday']) ? $_POST['weekday'] : null;		$cronjob['all_mins'] = $_POST['all_mins'];		$cronjob['all_hours'] = $_POST['all_hours'];		$cronjob['all_days'] = $_POST['all_days'];		$cronjob['all_months'] = $_POST['all_months'];		$cronjob['all_weekdays'] = $_POST['all_weekdays'];		$cronjob['who'] = 'root';		$cronjob['command'] = $config['minidlna']['homefolder']."bin/minidlna_rescan.sh";		$config['minidlna']['rescan'] = $_POST['rescan'];		} 		else  { header("Location: extensions_minidlna_rescan.php") ; }				if (isset($uuid) && (FALSE !== $cnid)) {				$a_cronjob[$cnid] = $cronjob;				$mode = UPDATENOTIFY_MODE_MODIFIED;			} else {				$a_cronjob[] = $cronjob;				$mode = UPDATENOTIFY_MODE_NEW;			}			updatenotify_set("cronjob", $mode, $cronjob['uuid']);		write_config();		header("Location: extensions_minidlna_rescan.php") ;	 }if (isset($_POST['apply']) && $_POST['apply']) {		$retval = 0;		if (!file_exists($d_sysrebootreqd_path)) {			$retval |= updatenotify_process("cronjob", "cronjob_process_updatenotification");			config_lock();			$retval |= rc_update_service("cron");			config_unlock();		}		$savemsg = get_std_save_message($retval);		if ($retval == 0) {			updatenotify_delete("cronjob");		}	}if (isset($_POST['Submit']) && $_POST['Submit'] === "clear") {	updatenotify_set("cronjob", UPDATENOTIFY_MODE_DIRTY, $_POST['uuid']);	$config['minidlna']['rescan'] = "manual";	if (is_array($config['cron']['job'])) {				$index = array_search_ex($data, $config['cron']['job'], "uuid");				if (false !== $index) {					unset($config['cron']['job'][$index]);					write_config();				}			}	write_config();	header("Location: extensions_minidlna_rescan.php");	exit;}function cronjob_process_updatenotification($mode, $data) {	global $config;	$retval = 0;	switch ($mode) {		case UPDATENOTIFY_MODE_NEW:		case UPDATENOTIFY_MODE_MODIFIED:			break;		case UPDATENOTIFY_MODE_DIRTY:			if (is_array($config['cron']['job'])) {				$index = array_search_ex($data, $config['cron']['job'], "uuid");				if (false !== $index) {					unset($config['cron']['job'][$index]);					write_config();				}			}			break;	}	return $retval;}?><?php include("fbegin.inc");?><script type="text/javascript"><!--$(document).ready(function () {	rescan_change();});function rescan_change() {	switch (document.iform.rescan.selectedIndex) {		case 0:			showElementById('schedresc_tr','hide');			showElementById('nowresc_tr','show');			showElementById('submit','hide');			break;		case 1:			showElementById('schedresc_tr','show');			showElementById('nowresc_tr','hide');			showElementById('submit','show');			break;			}}function set_selected(name) {	document.getElementsByName(name)[1].checked = true;}function delete_change() {	switch(document.getElementById('delete').checked) {		case false:			showElementById('delete_algorithm_tr','hide');			break;		case true:			showElementById('delete_algorithm_tr','show');			break;	}}// --></script><form action="extensions_minidlna_rescan.php" method="post" name="iform" id="iform">	<table width="100%" border="0" cellpadding="0" cellspacing="0">	<tr><td class="tabnavtbl">		<ul id="tabnav">			<li class="tabinact"><a href="extensions_minidlna.php"><span><?=gettext("Main")?></span></a></li>			<li class="tabact"><a href="extensions_minidlna_rescan.php"><span><?=gettext("Rescan")?></span></a></li>			<li class="tabinact"><a href="extensions_minidlna_log.php"><span><?=gettext("Log");?></span></a></li>		</ul>	</td></tr>		<tr>			<td class="tabcont">							<?php if (!empty($retval1)) print_info_box($retval1); ?>				<?php if (updatenotify_exists("cronjob")) print_config_change_box();?>								<table width="100%" border="0" cellpadding="6" cellspacing="0">				<?php html_titleline( gettext("Minidlna A/V Media Server rescan options")) ?>							<?php html_combobox("rescan", gettext("Rescan option"), $pconfig['rescan'], array("manual" => gettext("Manual"), "schedule" => gettext("Schedule")), "", false, false, "rescan_change()" );?>					<tr id='schedresc_tr'>						<td width="22%" valign="top" class="vncellreq"><?=gettext("Shedule rescan");?></td>						<td width="78%" class="vtable">							<table width="100%" border="0" cellpadding="5" cellspacing="0">								<tr>									<td class="listhdrlr"><?=gettext("Minutes");?></td>									<td class="listhdrr"><?=gettext("Hours");?></td>									<td class="listhdrr"><?=gettext("Days");?></td>									<td class="listhdrr"><?=gettext("Months");?></td>									<td class="listhdrr"><?=gettext("Week days");?></td>								</tr>								<tr>									<td class="listlr">										<input type="radio" name="all_mins" id="all_mins1" value="1" <?php if (1 == $pconfig['all_mins']) echo "checked=\"checked\"";?> />										<?=gettext("All");?><br />										<input type="radio" name="all_mins" id="all_mins2" value="0" <?php if (1 != $pconfig['all_mins']) echo "checked=\"checked\"";?> />										<?=gettext("Selected");?> ..<br />										<table>											<tr>												<td valign="top">													<select multiple="multiple" size="12" name="minute[]" id="minutes1" onchange="set_selected('all_mins')">														<?php for ($i = 0; $i <= 11; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['minute']) && is_array($pconfig['minute']) && in_array("$i", $pconfig['minute'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="12" name="minute[]" id="minutes2" onchange="set_selected('all_mins')">														<?php for ($i = 12; $i <= 23; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['minute']) && is_array($pconfig['minute']) && in_array("$i", $pconfig['minute'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="12" name="minute[]" id="minutes3" onchange="set_selected('all_mins')">														<?php for ($i = 24; $i <= 35; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['minute']) && is_array($pconfig['minute']) && in_array("$i", $pconfig['minute'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="12" name="minute[]" id="minutes4" onchange="set_selected('all_mins')">														<?php for ($i = 36; $i <= 47; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['minute']) && is_array($pconfig['minute']) && in_array("$i", $pconfig['minute'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="12" name="minute[]" id="minutes5" onchange="set_selected('all_mins')">														<?php for ($i = 48; $i <= 59; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['minute']) && is_array($pconfig['minute']) && in_array("$i", $pconfig['minute'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>											</tr>										</table>										<br />									</td>									<td class="listr" valign="top">										<input type="radio" name="all_hours" id="all_hours1" value="1" <?php if (1 == $pconfig['all_hours']) echo "checked=\"checked\"";?> />										<?=gettext("All");?><br />										<input type="radio" name="all_hours" id="all_hours2" value="0" <?php if (1 != $pconfig['all_hours']) echo "checked=\"checked\"";?> />										<?=gettext("Selected");?> ..<br />										<table>											<tr>												<td valign="top">													<select multiple="multiple" size="12" name="hour[]" id="hours1" onchange="set_selected('all_hours')">														<?php for ($i = 0; $i <= 11; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['hour']) && is_array($pconfig['hour']) && in_array("$i", $pconfig['hour'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="12" name="hour[]" id="hours2" onchange="set_selected('all_hours')">														<?php for ($i = 12; $i <= 23; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['hour']) && is_array($pconfig['hour']) && in_array("$i", $pconfig['hour'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>											</tr>										</table>									</td>									<td class="listr" valign="top">										<input type="radio" name="all_days" id="all_days1" value="1" <?php if (1 == $pconfig['all_days']) echo "checked=\"checked\"";?> />										<?=gettext("All");?><br />										<input type="radio" name="all_days" id="all_days2" value="0" <?php if (1 != $pconfig['all_days']) echo "checked=\"checked\"";?> />										<?=gettext("Selected");?> ..<br />										<table>											<tr>												<td valign="top">													<select multiple="multiple" size="12" name="day[]" id="days1" onchange="set_selected('all_days')">														<?php for ($i = 1; $i <= 12; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['day']) && is_array($pconfig['day']) && in_array("$i", $pconfig['day'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="12" name="day[]" id="days2" onchange="set_selected('all_days')">														<?php for ($i = 13; $i <= 24; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['day']) && is_array($pconfig['day']) && in_array("$i", $pconfig['day'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>												<td valign="top">													<select multiple="multiple" size="7" name="day[]" id="days3" onchange="set_selected('all_days')">														<?php for ($i = 25; $i <= 31; $i++):?>														<option value="<?=$i;?>" <?php if (!empty($pconfig['day']) && is_array($pconfig['day']) && in_array("$i", $pconfig['day'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($i);?></option>														<?php endfor;?>													</select>												</td>											</tr>										</table>									</td>									<td class="listr" valign="top">										<input type="radio" name="all_months" id="all_months1" value="1" <?php if (1 == $pconfig['all_months']) echo "checked=\"checked\"";?> />										<?=gettext("All");?><br />										<input type="radio" name="all_months" id="all_months2" value="0" <?php if (1 != $pconfig['all_months']) echo "checked=\"checked\"";?> />										<?=gettext("Selected");?> ..<br />										<table>											<tr>												<td valign="top">													<select multiple="multiple" size="12" name="month[]" id="months" onchange="set_selected('all_months')">														<?php $i = 1; foreach ($a_months as $month):?>														<option value="<?=$i;?>" <?php if (isset($pconfig['month']) && in_array("$i", $pconfig['month'])) echo "selected=\"selected\"";?>><?=htmlspecialchars($month);?></option>														<?php $i++; endforeach;?>													</select>												</td>											</tr>										</table>									</td>									<td class="listr" valign="top">										<input type="radio" name="all_weekdays" id="all_weekdays1" value="1" <?php if (1 == $pconfig['all_weekdays']) echo "checked=\"checked\"";?> />										<?=gettext("All");?><br />										<input type="radio" name="all_weekdays" id="all_weekdays2" value="0" <?php if (1 != $pconfig['all_weekdays']) echo "checked=\"checked\"";?> />										<?=gettext("Selected");?> ..<br />										<table>											<tr>												<td valign="top">													<select multiple="multiple" size="7" name="weekday[]" id="weekdays" onchange="set_selected('all_weekdays')">														<?php $i = 0; foreach ($a_weekdays as $day):?>														<option value="<?=$i;?>" <?php if (isset($pconfig['weekday']) && in_array("$i", $pconfig['weekday'])) echo "selected=\"selected\"";?>><?=$day;?></option>														<?php $i++; endforeach;?>													</select>												</td>											</tr>										</table>									</td>								</tr>							</table>							<span class="vexpl"><?=gettext("Note: Ctrl-click (or command-click on the Mac) to select and de-select minutes, hours, days and months.");?></span>						</td>					</tr>					<tr id='nowresc_tr'>						<td width="22%" valign="top" class="vncellreq"><?=gettext("Rescan now");?></td>						<td width="78%" class="vtable"><a href="extensions_minidlna_rescan.php?act=rescan">Rescan</a></td>					</tr>									</table>				<div id="submit">					<input name="Submit" type="submit" class="formbtn" value="<?=gettext("Save");?>" onclick="onsubmit_content(); enable_change(true)" />					<input name="Submit" type="submit" class="formbtn" value="<?=gettext("clear");?>" onclick="onsubmit_content(); enable_change(true)" />					<input name="uuid" type="hidden" value="<?=$pconfig['uuid'];?>" />				</div>			</td>		</tr>	</table>	<?php include("formend.inc");?></form><?php include("fend.inc");?>